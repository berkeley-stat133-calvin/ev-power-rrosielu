% Options for packages loaded elsewhere
% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
  english,
  letterpaper,
  DIV=11,
  numbers=noendperiod]{scrartcl}
\usepackage{xcolor}
\usepackage[margin=1in]{geometry}
\usepackage{amsmath,amssymb}
\setcounter{secnumdepth}{-\maxdimen} % remove section numbering
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math} % this also loads fontspec
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else
  % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
% Make \paragraph and \subparagraph free-standing
\makeatletter
\ifx\paragraph\undefined\else
  \let\oldparagraph\paragraph
  \renewcommand{\paragraph}{
    \@ifstar
      \xxxParagraphStar
      \xxxParagraphNoStar
  }
  \newcommand{\xxxParagraphStar}[1]{\oldparagraph*{#1}\mbox{}}
  \newcommand{\xxxParagraphNoStar}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
  \let\oldsubparagraph\subparagraph
  \renewcommand{\subparagraph}{
    \@ifstar
      \xxxSubParagraphStar
      \xxxSubParagraphNoStar
  }
  \newcommand{\xxxSubParagraphStar}[1]{\oldsubparagraph*{#1}\mbox{}}
  \newcommand{\xxxSubParagraphNoStar}[1]{\oldsubparagraph{#1}\mbox{}}
\fi
\makeatother

\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{241,243,245}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.40,0.45,0.13}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\BuiltInTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\ExtensionTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.28,0.35,0.67}{#1}}
\newcommand{\ImportTok}[1]{\textcolor[rgb]{0.00,0.46,0.62}{#1}}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\RegionMarkerTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.07,0.07,0.07}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}

\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\newsavebox\pandoc@box
\newcommand*\pandocbounded[1]{% scales image to fit in text height/width
  \sbox\pandoc@box{#1}%
  \Gscale@div\@tempa{\textheight}{\dimexpr\ht\pandoc@box+\dp\pandoc@box\relax}%
  \Gscale@div\@tempb{\linewidth}{\wd\pandoc@box}%
  \ifdim\@tempb\p@<\@tempa\p@\let\@tempa\@tempb\fi% select the smaller of both
  \ifdim\@tempa\p@<\p@\scalebox{\@tempa}{\usebox\pandoc@box}%
  \else\usebox{\pandoc@box}%
  \fi%
}
% Set default figure placement to htbp
\def\fps@figure{htbp}
\makeatother



\ifLuaTeX
\usepackage[bidi=basic]{babel}
\else
\usepackage[bidi=default]{babel}
\fi
% get rid of language-specific shorthands (see #6817):
\let\LanguageShortHands\languageshorthands
\def\languageshorthands#1{}
\ifLuaTeX
  \usepackage[english]{selnolig} % disable illegal ligatures
\fi


\setlength{\emergencystretch}{3em} % prevent overfull lines

\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}



 


\KOMAoption{captions}{tableheading}
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\AtBeginDocument{%
\ifdefined\contentsname
  \renewcommand*\contentsname{Table of contents}
\else
  \newcommand\contentsname{Table of contents}
\fi
\ifdefined\listfigurename
  \renewcommand*\listfigurename{List of Figures}
\else
  \newcommand\listfigurename{List of Figures}
\fi
\ifdefined\listtablename
  \renewcommand*\listtablename{List of Tables}
\else
  \newcommand\listtablename{List of Tables}
\fi
\ifdefined\figurename
  \renewcommand*\figurename{Figure}
\else
  \newcommand\figurename{Figure}
\fi
\ifdefined\tablename
  \renewcommand*\tablename{Table}
\else
  \newcommand\tablename{Table}
\fi
}
\@ifpackageloaded{float}{}{\usepackage{float}}
\floatstyle{ruled}
\@ifundefined{c@chapter}{\newfloat{codelisting}{h}{lop}}{\newfloat{codelisting}{h}{lop}[chapter]}
\floatname{codelisting}{Listing}
\newcommand*\listoflistings{\listof{codelisting}{List of Listings}}
\makeatother
\makeatletter
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\@ifpackageloaded{subcaption}{}{\usepackage{subcaption}}
\makeatother
\usepackage{bookmark}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same}
\hypersetup{
  pdftitle={EV Power - Lab 4 Project Report},
  pdfauthor={Rosie Lu},
  pdflang={en},
  colorlinks=true,
  linkcolor={blue},
  filecolor={Maroon},
  citecolor={Blue},
  urlcolor={Blue},
  pdfcreator={LaTeX via pandoc}}


\title{EV Power - Lab 4 Project Report}
\author{Rosie Lu}
\date{}
\begin{document}
\maketitle


\section{Example Solution 1}\label{example-solution-1}

\subsection{\texorpdfstring{\textbf{Part 0:
libraries}}{Part 0: libraries}}\label{part-0-libraries}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)  }\CommentTok{\# dplyr / readr / ggplot2 / tidyr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-- Attaching core tidyverse packages ------------------------ tidyverse 2.0.0 --
v dplyr     1.1.4     v readr     2.1.5
v forcats   1.0.1     v stringr   1.5.2
v ggplot2   4.0.0     v tibble    3.3.0
v lubridate 1.9.4     v tidyr     1.3.1
v purrr     1.1.0     
-- Conflicts ------------------------------------------ tidyverse_conflicts() --
x dplyr::filter() masks stats::filter()
x dplyr::lag()    masks stats::lag()
i Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(janitor)    }\CommentTok{\# clean\_names (if needed)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Attaching package: 'janitor'

The following objects are masked from 'package:stats':

    chisq.test, fisher.test
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(stringr)    }\CommentTok{\# string helpers}
\FunctionTok{library}\NormalTok{(scales)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Attaching package: 'scales'

The following object is masked from 'package:purrr':

    discard

The following object is masked from 'package:readr':

    col_factor
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(readr)}
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(tidyr)}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{\textbf{Part 1: Defining Research
Question}}{Part 1: Defining Research Question}}\label{part-1-defining-research-question}

\textbf{Chosen Research Question (RQ)}\\
Does a state's \textbf{renewable electricity share} relate to its
\textbf{EV registrations in 2023}?

\textbf{Why this matters}\\
EV climate benefits depend on the electricity mix. A quick association
check helps set expectations for policy and infrastructure.

\textbf{Operationalization}\\
- \emph{Renewable share (2021--2023)} = state-level renewable use
divided by total electricity use (from \texttt{renew-use-20xx.csv} and
\texttt{total-use-20xx.csv}, aggregated by state).\\
- \emph{EV adoption (2023)} = state-level EV registrations from
\texttt{ev-registrations-by-state-2023.csv}.

\textbf{Scope and approach}\\
We will (1) build a state--year table with \texttt{renewable\_share},
(2) extract 2023 and join EV counts, and (3) run simple descriptive
plots to inspect patterns.

\subsection{\texorpdfstring{\textbf{Part 2: Data Preparation and
Cleaning}}{Part 2: Data Preparation and Cleaning}}\label{part-2-data-preparation-and-cleaning}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# {-}{-}{-}{-} Part 2: Data Preparation \& Cleaning (robust, matches your headers) {-}{-}{-}{-}}

\NormalTok{DATA\_DIR }\OtherTok{\textless{}{-}} \StringTok{"data"}

\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-} paths {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{renew\_paths }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{\textasciigrave{}}\AttributeTok{2021}\StringTok{\textasciigrave{}} \OtherTok{=} \FunctionTok{file.path}\NormalTok{(DATA\_DIR, }\StringTok{"renew{-}use{-}2021.csv"}\NormalTok{),}
  \StringTok{\textasciigrave{}}\AttributeTok{2022}\StringTok{\textasciigrave{}} \OtherTok{=} \FunctionTok{file.path}\NormalTok{(DATA\_DIR, }\StringTok{"renew{-}use{-}2022.csv"}\NormalTok{),}
  \StringTok{\textasciigrave{}}\AttributeTok{2023}\StringTok{\textasciigrave{}} \OtherTok{=} \FunctionTok{file.path}\NormalTok{(DATA\_DIR, }\StringTok{"renew{-}use{-}2023.csv"}\NormalTok{)}
\NormalTok{)}

\NormalTok{total\_paths }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{\textasciigrave{}}\AttributeTok{2021}\StringTok{\textasciigrave{}} \OtherTok{=} \FunctionTok{file.path}\NormalTok{(DATA\_DIR, }\StringTok{"total{-}use{-}2021.csv"}\NormalTok{),}
  \StringTok{\textasciigrave{}}\AttributeTok{2022}\StringTok{\textasciigrave{}} \OtherTok{=} \FunctionTok{file.path}\NormalTok{(DATA\_DIR, }\StringTok{"total{-}use{-}2022.csv"}\NormalTok{),}
  \StringTok{\textasciigrave{}}\AttributeTok{2023}\StringTok{\textasciigrave{}} \OtherTok{=} \FunctionTok{file.path}\NormalTok{(DATA\_DIR, }\StringTok{"total{-}use{-}2023.csv"}\NormalTok{)}
\NormalTok{)}

\NormalTok{ev23\_path }\OtherTok{\textless{}{-}} \FunctionTok{file.path}\NormalTok{(DATA\_DIR, }\StringTok{"ev{-}registrations{-}by{-}state{-}2023.csv"}\NormalTok{)}

\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-} helper: safe numeric {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{safe\_num }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.numeric}\NormalTok{(x)) x }\ControlFlowTok{else}\NormalTok{ readr}\SpecialCharTok{::}\FunctionTok{parse\_number}\NormalTok{(}\FunctionTok{as.character}\NormalTok{(x))}
\NormalTok{\}}

\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-} renew reader (long, has State / Energy\_Source / Renewable\_Use\_20xx) {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{read\_renew }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(path, year\_colname) \{}
\NormalTok{  readr}\SpecialCharTok{::}\FunctionTok{read\_csv}\NormalTok{(path, }\AttributeTok{show\_col\_types =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{state =}\NormalTok{ State) }\SpecialCharTok{|\textgreater{}}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{state =} \FunctionTok{tolower}\NormalTok{(state)) }\SpecialCharTok{|\textgreater{}}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{renew\_val =} \SpecialCharTok{!!}\NormalTok{year\_colname) }\SpecialCharTok{|\textgreater{}}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{renew\_val =} \FunctionTok{safe\_num}\NormalTok{(renew\_val)) }\SpecialCharTok{|\textgreater{}}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(state) }\SpecialCharTok{|\textgreater{}}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{summarise}\NormalTok{(}\AttributeTok{renew\_energy =} \FunctionTok{sum}\NormalTok{(renew\_val, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\AttributeTok{.groups =} \StringTok{"drop"}\NormalTok{)}
\NormalTok{\}}

\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-} total reader (wide, has Energy\_Source + state abbreviations) {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{read\_total }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(path) \{}
\NormalTok{  wide }\OtherTok{\textless{}{-}}\NormalTok{ readr}\SpecialCharTok{::}\FunctionTok{read\_csv}\NormalTok{(path, }\AttributeTok{show\_col\_types =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{  has\_total }\OtherTok{\textless{}{-}} \StringTok{"Energy\_Source"} \SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(wide) }\SpecialCharTok{\&\&}
               \FunctionTok{any}\NormalTok{(wide}\SpecialCharTok{$}\NormalTok{Energy\_Source }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"Total"}\NormalTok{,}\StringTok{"TOTAL"}\NormalTok{,}\StringTok{"total"}\NormalTok{))}
\NormalTok{  long }\OtherTok{\textless{}{-}}\NormalTok{ wide }\SpecialCharTok{|\textgreater{}}
\NormalTok{    tidyr}\SpecialCharTok{::}\FunctionTok{pivot\_longer}\NormalTok{(}\AttributeTok{cols =} \SpecialCharTok{{-}}\NormalTok{Energy\_Source, }\AttributeTok{names\_to =} \StringTok{"state\_abb"}\NormalTok{, }\AttributeTok{values\_to =} \StringTok{"val"}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{val =} \FunctionTok{safe\_num}\NormalTok{(val)) }\SpecialCharTok{|\textgreater{}}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(val))}

  \ControlFlowTok{if}\NormalTok{ (has\_total) \{}
\NormalTok{    long2 }\OtherTok{\textless{}{-}}\NormalTok{ long }\SpecialCharTok{|\textgreater{}}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(Energy\_Source }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"Total"}\NormalTok{,}\StringTok{"TOTAL"}\NormalTok{,}\StringTok{"total"}\NormalTok{)) }\SpecialCharTok{|\textgreater{}}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(state\_abb, }\AttributeTok{total\_energy =}\NormalTok{ val)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    long2 }\OtherTok{\textless{}{-}}\NormalTok{ long }\SpecialCharTok{|\textgreater{}}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(state\_abb) }\SpecialCharTok{|\textgreater{}}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{summarise}\NormalTok{(}\AttributeTok{total\_energy =} \FunctionTok{sum}\NormalTok{(val, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\AttributeTok{.groups =} \StringTok{"drop"}\NormalTok{)}
\NormalTok{  \}}

\NormalTok{  abb\_map }\OtherTok{\textless{}{-}}\NormalTok{ tibble}\SpecialCharTok{::}\FunctionTok{tibble}\NormalTok{(}
    \AttributeTok{state\_abb =} \FunctionTok{c}\NormalTok{(}\StringTok{"AL"}\NormalTok{,}\StringTok{"AK"}\NormalTok{,}\StringTok{"AZ"}\NormalTok{,}\StringTok{"AR"}\NormalTok{,}\StringTok{"CA"}\NormalTok{,}\StringTok{"CO"}\NormalTok{,}\StringTok{"CT"}\NormalTok{,}\StringTok{"DE"}\NormalTok{,}\StringTok{"FL"}\NormalTok{,}\StringTok{"GA"}\NormalTok{,}\StringTok{"HI"}\NormalTok{,}\StringTok{"ID"}\NormalTok{,}\StringTok{"IL"}\NormalTok{,}\StringTok{"IN"}\NormalTok{,}\StringTok{"IA"}\NormalTok{,}
                  \StringTok{"KS"}\NormalTok{,}\StringTok{"KY"}\NormalTok{,}\StringTok{"LA"}\NormalTok{,}\StringTok{"ME"}\NormalTok{,}\StringTok{"MD"}\NormalTok{,}\StringTok{"MA"}\NormalTok{,}\StringTok{"MI"}\NormalTok{,}\StringTok{"MN"}\NormalTok{,}\StringTok{"MS"}\NormalTok{,}\StringTok{"MO"}\NormalTok{,}\StringTok{"MT"}\NormalTok{,}\StringTok{"NE"}\NormalTok{,}\StringTok{"NV"}\NormalTok{,}\StringTok{"NH"}\NormalTok{,}\StringTok{"NJ"}\NormalTok{,}
                  \StringTok{"NM"}\NormalTok{,}\StringTok{"NY"}\NormalTok{,}\StringTok{"NC"}\NormalTok{,}\StringTok{"ND"}\NormalTok{,}\StringTok{"OH"}\NormalTok{,}\StringTok{"OK"}\NormalTok{,}\StringTok{"OR"}\NormalTok{,}\StringTok{"PA"}\NormalTok{,}\StringTok{"RI"}\NormalTok{,}\StringTok{"SC"}\NormalTok{,}\StringTok{"SD"}\NormalTok{,}\StringTok{"TN"}\NormalTok{,}\StringTok{"TX"}\NormalTok{,}\StringTok{"UT"}\NormalTok{,}\StringTok{"VT"}\NormalTok{,}
                  \StringTok{"VA"}\NormalTok{,}\StringTok{"WA"}\NormalTok{,}\StringTok{"WV"}\NormalTok{,}\StringTok{"WI"}\NormalTok{,}\StringTok{"WY"}\NormalTok{,}\StringTok{"DC"}\NormalTok{,}\StringTok{"US"}\NormalTok{),}
    \AttributeTok{state =} \FunctionTok{tolower}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
      \StringTok{"Alabama"}\NormalTok{,}\StringTok{"Alaska"}\NormalTok{,}\StringTok{"Arizona"}\NormalTok{,}\StringTok{"Arkansas"}\NormalTok{,}\StringTok{"California"}\NormalTok{,}\StringTok{"Colorado"}\NormalTok{,}\StringTok{"Connecticut"}\NormalTok{,}\StringTok{"Delaware"}\NormalTok{,}
      \StringTok{"Florida"}\NormalTok{,}\StringTok{"Georgia"}\NormalTok{,}\StringTok{"Hawaii"}\NormalTok{,}\StringTok{"Idaho"}\NormalTok{,}\StringTok{"Illinois"}\NormalTok{,}\StringTok{"Indiana"}\NormalTok{,}\StringTok{"Iowa"}\NormalTok{,}\StringTok{"Kansas"}\NormalTok{,}\StringTok{"Kentucky"}\NormalTok{,}
      \StringTok{"Louisiana"}\NormalTok{,}\StringTok{"Maine"}\NormalTok{,}\StringTok{"Maryland"}\NormalTok{,}\StringTok{"Massachusetts"}\NormalTok{,}\StringTok{"Michigan"}\NormalTok{,}\StringTok{"Minnesota"}\NormalTok{,}\StringTok{"Mississippi"}\NormalTok{,}
      \StringTok{"Missouri"}\NormalTok{,}\StringTok{"Montana"}\NormalTok{,}\StringTok{"Nebraska"}\NormalTok{,}\StringTok{"Nevada"}\NormalTok{,}\StringTok{"New Hampshire"}\NormalTok{,}\StringTok{"New Jersey"}\NormalTok{,}\StringTok{"New Mexico"}\NormalTok{,}
      \StringTok{"New York"}\NormalTok{,}\StringTok{"North Carolina"}\NormalTok{,}\StringTok{"North Dakota"}\NormalTok{,}\StringTok{"Ohio"}\NormalTok{,}\StringTok{"Oklahoma"}\NormalTok{,}\StringTok{"Oregon"}\NormalTok{,}\StringTok{"Pennsylvania"}\NormalTok{,}
      \StringTok{"Rhode Island"}\NormalTok{,}\StringTok{"South Carolina"}\NormalTok{,}\StringTok{"South Dakota"}\NormalTok{,}\StringTok{"Tennessee"}\NormalTok{,}\StringTok{"Texas"}\NormalTok{,}\StringTok{"Utah"}\NormalTok{,}\StringTok{"Vermont"}\NormalTok{,}
      \StringTok{"Virginia"}\NormalTok{,}\StringTok{"Washington"}\NormalTok{,}\StringTok{"West Virginia"}\NormalTok{,}\StringTok{"Wisconsin"}\NormalTok{,}\StringTok{"Wyoming"}\NormalTok{,}\StringTok{"District of Columbia"}\NormalTok{,}\StringTok{"US"}\NormalTok{))}
\NormalTok{  )}

\NormalTok{  long2 }\SpecialCharTok{|\textgreater{}}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{left\_join}\NormalTok{(abb\_map, }\AttributeTok{by =} \StringTok{"state\_abb"}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(state), state }\SpecialCharTok{!=} \StringTok{"us"}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(state, total\_energy)}
\NormalTok{\}}

\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-} EV 2023 reader (first col = state name, second col = value) {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{read\_ev23 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(path) \{}
\NormalTok{  ev\_raw }\OtherTok{\textless{}{-}}\NormalTok{ readr}\SpecialCharTok{::}\FunctionTok{read\_csv}\NormalTok{(path, }\AttributeTok{show\_col\_types =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{  ev\_cols }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(ev\_raw)}
  \FunctionTok{stopifnot}\NormalTok{(}\FunctionTok{length}\NormalTok{(ev\_cols) }\SpecialCharTok{\textgreater{}=} \DecValTok{2}\NormalTok{)  }\CommentTok{\# ensure two columns exist}
\NormalTok{  ev\_raw }\SpecialCharTok{|\textgreater{}}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{state\_raw =} \SpecialCharTok{!!}\NormalTok{ev\_cols[}\DecValTok{1}\NormalTok{], }\AttributeTok{ev\_val =} \SpecialCharTok{!!}\NormalTok{ev\_cols[}\DecValTok{2}\NormalTok{]) }\SpecialCharTok{|\textgreater{}}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{state =} \FunctionTok{tolower}\NormalTok{(}\FunctionTok{as.character}\NormalTok{(state\_raw)),}
                  \AttributeTok{ev\_count =} \FunctionTok{safe\_num}\NormalTok{(ev\_val)) }\SpecialCharTok{|\textgreater{}}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(state, ev\_count)}
\NormalTok{\}}

\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-} build yearly tables {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{renew\_all }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(}
  \FunctionTok{read\_renew}\NormalTok{(renew\_paths[}\StringTok{"2021"}\NormalTok{], }\StringTok{"Renewable\_Use\_2021"}\NormalTok{) }\SpecialCharTok{|\textgreater{}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{year =} \DecValTok{2021}\NormalTok{),}
  \FunctionTok{read\_renew}\NormalTok{(renew\_paths[}\StringTok{"2022"}\NormalTok{], }\StringTok{"Renewable\_Use\_2022"}\NormalTok{) }\SpecialCharTok{|\textgreater{}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{year =} \DecValTok{2022}\NormalTok{),}
  \FunctionTok{read\_renew}\NormalTok{(renew\_paths[}\StringTok{"2023"}\NormalTok{], }\StringTok{"Renewable\_Use\_2023"}\NormalTok{) }\SpecialCharTok{|\textgreater{}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{year =} \DecValTok{2023}\NormalTok{)}
\NormalTok{)}

\NormalTok{total\_all }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(}
  \FunctionTok{read\_total}\NormalTok{(total\_paths[}\StringTok{"2021"}\NormalTok{]) }\SpecialCharTok{|\textgreater{}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{year =} \DecValTok{2021}\NormalTok{),}
  \FunctionTok{read\_total}\NormalTok{(total\_paths[}\StringTok{"2022"}\NormalTok{]) }\SpecialCharTok{|\textgreater{}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{year =} \DecValTok{2022}\NormalTok{),}
  \FunctionTok{read\_total}\NormalTok{(total\_paths[}\StringTok{"2023"}\NormalTok{]) }\SpecialCharTok{|\textgreater{}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{year =} \DecValTok{2023}\NormalTok{)}
\NormalTok{)}

\NormalTok{ev23 }\OtherTok{\textless{}{-}} \FunctionTok{read\_ev23}\NormalTok{(ev23\_path)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
New names:
* `` -> `...2`
\end{verbatim}

\begin{verbatim}
Warning: There was 1 warning in `dplyr::mutate()`.
i In argument: `ev_count = safe_num(ev_val)`.
Caused by warning:
! 1 parsing failure.
row col expected    actual
  2  -- a number Count-EVs
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-} join \& compute renewable\_share {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{joined\_yearly }\OtherTok{\textless{}{-}}\NormalTok{ renew\_all }\SpecialCharTok{|\textgreater{}}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{left\_join}\NormalTok{(total\_all, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"state"}\NormalTok{,}\StringTok{"year"}\NormalTok{)) }\SpecialCharTok{|\textgreater{}}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{renewable\_share =}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{if\_else}\NormalTok{(total\_energy }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{, renew\_energy }\SpecialCharTok{/}\NormalTok{ total\_energy, }\ConstantTok{NA\_real\_}\NormalTok{))}

\NormalTok{df\_2023 }\OtherTok{\textless{}{-}}\NormalTok{ joined\_yearly }\SpecialCharTok{|\textgreater{}}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(year }\SpecialCharTok{==} \DecValTok{2023}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{left\_join}\NormalTok{(ev23, }\AttributeTok{by =} \StringTok{"state"}\NormalTok{)}

\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-} basic checks {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\FunctionTok{cat}\NormalTok{(}\StringTok{"Rows in renew\_all:"}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(renew\_all), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Rows in renew_all: 156 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\StringTok{"Rows in total\_all:"}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(total\_all), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Rows in total_all: 153 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\StringTok{"Rows in df\_2023:"}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df\_2023), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Rows in df_2023: 52 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{glimpse}\NormalTok{(joined\_yearly)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Rows: 156
Columns: 5
$ state           <chr> "ak", "al", "ar", "az", "ca", "co", "ct", "dc", "de", ~
$ renew_energy    <dbl> 9598, 239816, 89714, 99266, 810020, 103956, 49306, 248~
$ year            <dbl> 2021, 2021, 2021, 2021, 2021, 2021, 2021, 2021, 2021, ~
$ total_energy    <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA~
$ renewable_share <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA~
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{glimpse}\NormalTok{(df\_2023)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Rows: 52
Columns: 6
$ state           <chr> "ak", "al", "ar", "az", "ca", "co", "ct", "dc", "de", ~
$ renew_energy    <dbl> 10088, 222189, 87277, 108445, 1065179, 115062, 48983, ~
$ year            <dbl> 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, ~
$ total_energy    <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA~
$ renewable_share <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA~
$ ev_count        <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA~
\end{verbatim}

\subsection{\texorpdfstring{\textbf{Part 3: Joining / Pivoting Datasets
for
Analysis}}{Part 3: Joining / Pivoting Datasets for Analysis}}\label{part-3-joining-pivoting-datasets-for-analysis}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# {-}{-}{-}{-} Part 3: Simple EDA (pipe |\textgreater{} version, fixed) {-}{-}{-}{-}}
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(scales)}
\FunctionTok{library}\NormalTok{(forcats)}
\FunctionTok{library}\NormalTok{(stringr)}

\CommentTok{\# 0) Normalize state strings \& rebuild joins (helps avoid empty matches)}
\NormalTok{norm\_state }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(s) \{}
\NormalTok{  s }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{tolower}\NormalTok{() }\SpecialCharTok{|\textgreater{}}
\NormalTok{    stringr}\SpecialCharTok{::}\FunctionTok{str\_replace\_all}\NormalTok{(}\StringTok{"[\^{}a{-}z ]"}\NormalTok{, }\StringTok{" "}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
\NormalTok{    stringr}\SpecialCharTok{::}\FunctionTok{str\_squish}\NormalTok{()}
\NormalTok{\}}
\NormalTok{alias\_fix }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(s) dplyr}\SpecialCharTok{::}\FunctionTok{recode}\NormalTok{(}
\NormalTok{  s,}
  \StringTok{"dc"} \OtherTok{=} \StringTok{"district of columbia"}\NormalTok{,}
  \StringTok{"washington dc"} \OtherTok{=} \StringTok{"district of columbia"}\NormalTok{,}
  \StringTok{"washington d c"} \OtherTok{=} \StringTok{"district of columbia"}\NormalTok{,}
  \StringTok{"d c"} \OtherTok{=} \StringTok{"district of columbia"}\NormalTok{,}
  \AttributeTok{.default =}\NormalTok{ s}
\NormalTok{)}

\FunctionTok{stopifnot}\NormalTok{(}\FunctionTok{exists}\NormalTok{(}\StringTok{"renew\_all"}\NormalTok{), }\FunctionTok{exists}\NormalTok{(}\StringTok{"total\_all"}\NormalTok{), }\FunctionTok{exists}\NormalTok{(}\StringTok{"ev23"}\NormalTok{))}

\NormalTok{renew\_all }\OtherTok{\textless{}{-}}\NormalTok{ renew\_all }\SpecialCharTok{|\textgreater{}} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{state =} \FunctionTok{alias\_fix}\NormalTok{(}\FunctionTok{norm\_state}\NormalTok{(state)))}
\NormalTok{total\_all }\OtherTok{\textless{}{-}}\NormalTok{ total\_all }\SpecialCharTok{|\textgreater{}} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{state =} \FunctionTok{alias\_fix}\NormalTok{(}\FunctionTok{norm\_state}\NormalTok{(state)))}
\NormalTok{ev23      }\OtherTok{\textless{}{-}}\NormalTok{ ev23      }\SpecialCharTok{|\textgreater{}} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{state =} \FunctionTok{alias\_fix}\NormalTok{(}\FunctionTok{norm\_state}\NormalTok{(state)))}

\NormalTok{joined\_yearly }\OtherTok{\textless{}{-}}
\NormalTok{  renew\_all }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{left\_join}\NormalTok{(total\_all, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"state"}\NormalTok{,}\StringTok{"year"}\NormalTok{)) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{renewable\_share =} \FunctionTok{if\_else}\NormalTok{(}\FunctionTok{is.finite}\NormalTok{(total\_energy) }\SpecialCharTok{\&}\NormalTok{ total\_energy }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{,}
\NormalTok{                                   renew\_energy }\SpecialCharTok{/}\NormalTok{ total\_energy, }\ConstantTok{NA\_real\_}\NormalTok{))}

\NormalTok{df\_2023 }\OtherTok{\textless{}{-}}
\NormalTok{  joined\_yearly }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{filter}\NormalTok{(year }\SpecialCharTok{==} \DecValTok{2023}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{left\_join}\NormalTok{(ev23, }\AttributeTok{by =} \StringTok{"state"}\NormalTok{)}

\FunctionTok{cat}\NormalTok{(}\StringTok{"Non{-}NA pairs in 2023:"}\NormalTok{,}
    \FunctionTok{sum}\NormalTok{(}\FunctionTok{is.finite}\NormalTok{(df\_2023}\SpecialCharTok{$}\NormalTok{renewable\_share) }\SpecialCharTok{\&} \FunctionTok{is.finite}\NormalTok{(df\_2023}\SpecialCharTok{$}\NormalTok{ev\_count)), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Non-NA pairs in 2023: 1 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 1) Top{-}10 states by renewable share (2023)}
\NormalTok{top10\_share }\OtherTok{\textless{}{-}}
\NormalTok{  df\_2023 }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{filter}\NormalTok{(}\FunctionTok{is.finite}\NormalTok{(renewable\_share)) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(renewable\_share)) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{slice\_head}\NormalTok{(}\AttributeTok{n =} \DecValTok{10}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{state =} \FunctionTok{fct\_reorder}\NormalTok{(state, renewable\_share))}

\FunctionTok{ggplot}\NormalTok{(top10\_share, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ state, }\AttributeTok{y =}\NormalTok{ renewable\_share)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{labels =} \FunctionTok{percent\_format}\NormalTok{(}\AttributeTok{accuracy =} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Top 10 States by Renewable Share (2023)"}\NormalTok{,}
       \AttributeTok{x =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{y =} \StringTok{"Renewable share"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{report_files/figure-pdf/unnamed-chunk-3-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 2) Scatter: renewable share vs EV registrations (2023)}
\NormalTok{scatter\_df }\OtherTok{\textless{}{-}}
\NormalTok{  df\_2023 }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{renewable\_share =} \FunctionTok{as.numeric}\NormalTok{(renewable\_share),}
    \AttributeTok{ev\_count        =} \FunctionTok{as.numeric}\NormalTok{(ev\_count)}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{filter}\NormalTok{(}\FunctionTok{is.finite}\NormalTok{(renewable\_share), }\FunctionTok{is.finite}\NormalTok{(ev\_count))}

\FunctionTok{ggplot}\NormalTok{(scatter\_df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ renewable\_share, }\AttributeTok{y =}\NormalTok{ ev\_count)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha =} \FloatTok{0.85}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{, }\AttributeTok{se =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{labels =} \FunctionTok{percent\_format}\NormalTok{(}\AttributeTok{accuracy =} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{trans  =} \StringTok{"log1p"}\NormalTok{,}
    \AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{label\_number}\NormalTok{(}\AttributeTok{scale\_cut =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{cut\_si}\NormalTok{(}\StringTok{" "}\NormalTok{))}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Renewable Share vs EV Registrations (2023)"}\NormalTok{,}
       \AttributeTok{x =} \StringTok{"Renewable share (2023)"}\NormalTok{,}
       \AttributeTok{y =} \StringTok{"EV registrations (log1p scale)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
`geom_smooth()` using formula = 'y ~ x'
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{report_files/figure-pdf/unnamed-chunk-3-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 3) Robust correlation}
\NormalTok{pairs\_df }\OtherTok{\textless{}{-}}
\NormalTok{  scatter\_df }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{select}\NormalTok{(renewable\_share, ev\_count)}

\ControlFlowTok{if}\NormalTok{ (}\FunctionTok{nrow}\NormalTok{(pairs\_df) }\SpecialCharTok{\textgreater{}=} \DecValTok{2}\NormalTok{) \{}
\NormalTok{  corr\_val }\OtherTok{\textless{}{-}} \FunctionTok{cor}\NormalTok{(pairs\_df}\SpecialCharTok{$}\NormalTok{renewable\_share, }\FunctionTok{log1p}\NormalTok{(pairs\_df}\SpecialCharTok{$}\NormalTok{ev\_count), }\AttributeTok{use =} \StringTok{"complete.obs"}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Correlation between renewable\_share and log1p(EV registrations):"}\NormalTok{,}
      \FunctionTok{round}\NormalTok{(corr\_val, }\DecValTok{3}\NormalTok{), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{\} }\ControlFlowTok{else}\NormalTok{ \{}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Correlation not computed: need \textgreater{}= 2 complete pairs; got "}\NormalTok{,}
      \FunctionTok{nrow}\NormalTok{(pairs\_df), }\StringTok{".}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Correlation not computed: need >= 2 complete pairs; got 1.
\end{verbatim}

\subsection{\texorpdfstring{\textbf{Part 4: Mapping
Visualization}}{Part 4: Mapping Visualization}}\label{part-4-mapping-visualization}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# {-}{-}{-}{-} Part 4: Findings \& Simple Model (pipe |\textgreater{} version, minimal) {-}{-}{-}{-}}
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(tibble)}
\FunctionTok{library}\NormalTok{(scales)}

\CommentTok{\# 0) Guard + prepare analysis data}
\FunctionTok{stopifnot}\NormalTok{(}\FunctionTok{exists}\NormalTok{(}\StringTok{"df\_2023"}\NormalTok{))}

\NormalTok{ana\_df }\OtherTok{\textless{}{-}}
\NormalTok{  df\_2023 }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{renewable\_share =} \FunctionTok{as.numeric}\NormalTok{(renewable\_share),}
    \AttributeTok{ev\_count        =} \FunctionTok{as.numeric}\NormalTok{(ev\_count)}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{filter}\NormalTok{(}\FunctionTok{is.finite}\NormalTok{(renewable\_share), }\FunctionTok{is.finite}\NormalTok{(ev\_count))}

\CommentTok{\# 1) Quick overview table}
\NormalTok{stats\_tbl }\OtherTok{\textless{}{-}}
\NormalTok{  ana\_df }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarise}\NormalTok{(}
    \AttributeTok{n\_rows                 =} \FunctionTok{n}\NormalTok{(),}
    \AttributeTok{n\_states\_with\_data     =} \FunctionTok{n\_distinct}\NormalTok{(state),}
    \AttributeTok{renewable\_share\_median =} \FunctionTok{median}\NormalTok{(renewable\_share),}
    \AttributeTok{renewable\_share\_IQR    =} \FunctionTok{IQR}\NormalTok{(renewable\_share),}
    \AttributeTok{ev\_median              =} \FunctionTok{median}\NormalTok{(ev\_count),}
    \AttributeTok{ev\_IQR                 =} \FunctionTok{IQR}\NormalTok{(ev\_count)}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{renewable\_share\_median =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(renewable\_share\_median, }\AttributeTok{accuracy =} \FloatTok{0.1}\NormalTok{),}
    \AttributeTok{renewable\_share\_IQR    =}\NormalTok{ scales}\SpecialCharTok{::}\FunctionTok{percent}\NormalTok{(renewable\_share\_IQR,    }\AttributeTok{accuracy =} \FloatTok{0.1}\NormalTok{),}
    \AttributeTok{ev\_median              =} \FunctionTok{format}\NormalTok{(ev\_median, }\AttributeTok{big.mark =} \StringTok{","}\NormalTok{),}
    \AttributeTok{ev\_IQR                 =} \FunctionTok{format}\NormalTok{(ev\_IQR,    }\AttributeTok{big.mark =} \StringTok{","}\NormalTok{)}
\NormalTok{  )}

\ControlFlowTok{if}\NormalTok{ (}\FunctionTok{requireNamespace}\NormalTok{(}\StringTok{"knitr"}\NormalTok{, }\AttributeTok{quietly =} \ConstantTok{TRUE}\NormalTok{)) \{}
\NormalTok{  knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(stats\_tbl, }\AttributeTok{caption =} \StringTok{"Overview of 2023 data used in analysis"}\NormalTok{)}
\NormalTok{\} }\ControlFlowTok{else}\NormalTok{ \{}
  \FunctionTok{print}\NormalTok{(stats\_tbl)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}
  >{\raggedleft\arraybackslash}p{(\linewidth - 10\tabcolsep) * \real{0.0814}}
  >{\raggedleft\arraybackslash}p{(\linewidth - 10\tabcolsep) * \real{0.2209}}
  >{\raggedright\arraybackslash}p{(\linewidth - 10\tabcolsep) * \real{0.2674}}
  >{\raggedright\arraybackslash}p{(\linewidth - 10\tabcolsep) * \real{0.2326}}
  >{\raggedright\arraybackslash}p{(\linewidth - 10\tabcolsep) * \real{0.1163}}
  >{\raggedright\arraybackslash}p{(\linewidth - 10\tabcolsep) * \real{0.0814}}@{}}
\caption{Overview of 2023 data used in analysis}\tabularnewline
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedleft
n\_rows
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedleft
n\_states\_with\_data
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
renewable\_share\_median
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
renewable\_share\_IQR
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
ev\_median
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
ev\_IQR
\end{minipage} \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedleft
n\_rows
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedleft
n\_states\_with\_data
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
renewable\_share\_median
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
renewable\_share\_IQR
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
ev\_median
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
ev\_IQR
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1 & 1 & 6.0\% & 0.0\% & 8,066 & 0 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 2) Minimal linear model: log1p(EV) \textasciitilde{} renewable\_share}
\ControlFlowTok{if}\NormalTok{ (}\FunctionTok{nrow}\NormalTok{(ana\_df) }\SpecialCharTok{\textgreater{}=} \DecValTok{3}\NormalTok{) \{}
\NormalTok{  fit     }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(}\FunctionTok{log1p}\NormalTok{(ev\_count) }\SpecialCharTok{\textasciitilde{}}\NormalTok{ renewable\_share, }\AttributeTok{data =}\NormalTok{ ana\_df)}
\NormalTok{  fit\_sum }\OtherTok{\textless{}{-}} \FunctionTok{summary}\NormalTok{(fit)}

\NormalTok{  coef\_mat }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(fit\_sum)}
\NormalTok{  coef\_tbl }\OtherTok{\textless{}{-}}
    \FunctionTok{tibble}\NormalTok{(}
      \AttributeTok{term      =} \FunctionTok{rownames}\NormalTok{(coef\_mat),}
      \AttributeTok{estimate  =} \FunctionTok{unname}\NormalTok{(coef\_mat[, }\DecValTok{1}\NormalTok{]),}
      \AttributeTok{std\_error =} \FunctionTok{unname}\NormalTok{(coef\_mat[, }\DecValTok{2}\NormalTok{]),}
      \AttributeTok{t\_value   =} \FunctionTok{unname}\NormalTok{(coef\_mat[, }\DecValTok{3}\NormalTok{]),}
      \AttributeTok{p\_value   =} \FunctionTok{unname}\NormalTok{(coef\_mat[, }\DecValTok{4}\NormalTok{])}
\NormalTok{    ) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{mutate}\NormalTok{(}
      \AttributeTok{estimate  =} \FunctionTok{round}\NormalTok{(estimate, }\DecValTok{4}\NormalTok{),}
      \AttributeTok{std\_error =} \FunctionTok{round}\NormalTok{(std\_error, }\DecValTok{4}\NormalTok{),}
      \AttributeTok{t\_value   =} \FunctionTok{round}\NormalTok{(t\_value, }\DecValTok{3}\NormalTok{),}
      \AttributeTok{p\_value   =} \FunctionTok{signif}\NormalTok{(p\_value, }\DecValTok{3}\NormalTok{)}
\NormalTok{    )}

  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{requireNamespace}\NormalTok{(}\StringTok{"knitr"}\NormalTok{, }\AttributeTok{quietly =} \ConstantTok{TRUE}\NormalTok{)) \{}
\NormalTok{    knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(coef\_tbl, }\AttributeTok{caption =} \StringTok{"OLS: log1p(EV registrations) \textasciitilde{} renewable\_share"}\NormalTok{)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \FunctionTok{print}\NormalTok{(coef\_tbl)}
\NormalTok{  \}}

\NormalTok{  r2  }\OtherTok{\textless{}{-}} \FunctionTok{unname}\NormalTok{(fit\_sum}\SpecialCharTok{$}\NormalTok{r.squared)}
\NormalTok{  r2a }\OtherTok{\textless{}{-}} \FunctionTok{unname}\NormalTok{(fit\_sum}\SpecialCharTok{$}\NormalTok{adj.r.squared)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"R{-}squared:"}\NormalTok{, }\FunctionTok{round}\NormalTok{(r2, }\DecValTok{3}\NormalTok{), }\StringTok{" | Adjusted R{-}squared:"}\NormalTok{, }\FunctionTok{round}\NormalTok{(r2a, }\DecValTok{3}\NormalTok{), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}

\NormalTok{  slope }\OtherTok{\textless{}{-}}\NormalTok{ coef\_tbl}\SpecialCharTok{$}\NormalTok{estimate[coef\_tbl}\SpecialCharTok{$}\NormalTok{term }\SpecialCharTok{==} \StringTok{"renewable\_share"}\NormalTok{]}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(slope) }\SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\&\&} \FunctionTok{is.finite}\NormalTok{(slope)) \{}
\NormalTok{    msg }\OtherTok{\textless{}{-}} \ControlFlowTok{if}\NormalTok{ (slope }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{) }\StringTok{"positive"} \ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (slope }\SpecialCharTok{\textless{}} \DecValTok{0}\NormalTok{) }\StringTok{"negative"} \ControlFlowTok{else} \StringTok{"near zero"}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"Interpretation: the slope on renewable\_share is"}\NormalTok{, msg,}
        \StringTok{"(estimate ="}\NormalTok{, }\FunctionTok{round}\NormalTok{(slope, }\DecValTok{4}\NormalTok{), }\StringTok{").}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{\} }\ControlFlowTok{else}\NormalTok{ \{}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Model not fitted: need at least 3 complete observations; got "}\NormalTok{,}
      \FunctionTok{nrow}\NormalTok{(ana\_df), }\StringTok{".}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Model not fitted: need at least 3 complete observations; got 1.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# 3) (Optional) small result table for appendix}
\NormalTok{results\_small }\OtherTok{\textless{}{-}}
\NormalTok{  ana\_df }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{select}\NormalTok{(state, renewable\_share, ev\_count) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(renewable\_share)) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{slice\_head}\NormalTok{(}\AttributeTok{n =} \DecValTok{12}\NormalTok{)}

\ControlFlowTok{if}\NormalTok{ (}\FunctionTok{requireNamespace}\NormalTok{(}\StringTok{"knitr"}\NormalTok{, }\AttributeTok{quietly =} \ConstantTok{TRUE}\NormalTok{)) \{}
\NormalTok{  knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(results\_small, }\AttributeTok{caption =} \StringTok{"Top states by renewable share with EV counts (2023)"}\NormalTok{)}
\NormalTok{\} }\ControlFlowTok{else}\NormalTok{ \{}
  \FunctionTok{print}\NormalTok{(results\_small)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lrr@{}}
\caption{Top states by renewable share with EV counts
(2023)}\tabularnewline
\toprule\noalign{}
state & renewable\_share & ev\_count \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
state & renewable\_share & ev\_count \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
district of columbia & 0.0603588 & 8066 \\
\end{longtable}




\end{document}
